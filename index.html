<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPA Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans Arabic', sans-serif;
            background-color: #f9fafb;
            /* Very light gray (almost white) */
            color: #111827;
            /* Gray 900 for high contrast text */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 680px;
            /* Reduced width */
            width: 100%;
            background-color: #ffffff;
            border-radius: 0.5rem;
            /* 8px */
            border: 1px solid #e5e7eb;
            /* Gray 200 border */
            padding: 1.5rem;
            margin-top: 1rem;
            margin-bottom: 2rem;
        }

        .input-field,
        .select-field {
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            /* Gray 300 */
            border-radius: 0.25rem;
            /* 4px */
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
            color: #111827;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            width: 100%;
        }

        .input-field::placeholder {
            color: #6b7280;
            /* Gray 500 */
        }

        .input-field:focus,
        .select-field:focus {
            border-color: #2563eb;
            /* Blue 600 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            /* Blue focus ring */
            outline: none;
        }

        .btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border-radius: 0.25rem;
            /* 4px */
            font-weight: 500;
            /* Medium weight */
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid transparent;
        }

        .btn-primary {
            background-color: #2563eb;
            /* Blue 600 */
            color: white;
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
            /* Blue 700 */
        }

        .btn-secondary {
            background-color: #e5e7eb;
            /* Gray 200 */
            color: #1f2937;
            /* Gray 800 */
            border-color: #d1d5db;
            /* Gray 300 */
        }

        .btn-secondary:hover {
            background-color: #d1d5db;
            /* Gray 300 */
        }

        .btn-danger {
            background-color: #dc2626;
            /* Red 600 */
            color: white;
        }

        .btn-danger:hover {
            background-color: #b91c1c;
            /* Red 700 */
        }

        .btn-success {
            background-color: #16a34a;
            /* Green 600 */
            color: white;
        }

        .btn-success:hover {
            background-color: #15803d;
            /* Green 700 */
        }

        .btn-icon {
            padding: 0.375rem;
            /* Smaller padding for icon buttons */
        }

        .btn-icon svg {
            width: 1rem;
            height: 1rem;
        }


        .app-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .app-header h1 {
            font-size: 1.5rem;
            /* text-2xl */
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .app-header p {
            font-size: 0.875rem;
            /* text-sm */
            color: #4b5563;
            /* Gray 600 */
        }

        .section {
            /* Replaced section-card */
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
            /* Gray 200, simple separator */
        }

        .section:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        .section-title {
            /* Replaced section-card-title */
            font-size: 1.125rem;
            /* text-lg */
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.75rem;
        }

        .semester-block {
            background-color: #f9fafb;
            /* Gray 50 */
            border: 1px solid #e5e7eb;
            /* Gray 200 */
            border-radius: 0.375rem;
            /* 6px */
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .semester-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .semester-title-input {
            font-weight: 500;
            /* Medium */
            font-size: 0.95rem;
            border: none;
            background: transparent;
            padding: 0.125rem 0;
            color: #111827;
            width: calc(100% - 130px);
            /* Adjusted width to leave space for button */
        }

        .semester-title-input:focus {
            outline: none;
            border-bottom: 1px dashed #2563eb;
        }

        .course-row {
            display: grid;
            grid-template-columns: minmax(100px, 1fr) 80px 110px 36px;
            gap: 0.5rem;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f3f4f6;
            /* Gray 100 */
        }

        .course-row:last-child {
            border-bottom: none;
        }

        @media (max-width: 500px) {

            /* Simplified responsive stacking */
            .course-row {
                grid-template-columns: 1fr;
                /* Full stack */
                gap: 0.5rem;
            }

            .course-row>* {
                margin-bottom: 0.5rem;
            }

            .course-row>*:last-child {
                margin-bottom: 0;
            }

            .semester-title-input {
                width: calc(100% - 120px);
                /* Adjust for smaller screens if button wraps */
            }
        }

        .results-display-area {
            /* Replaced results-card */
            background-color: #f3f4f6;
            /* Gray 100 for slight emphasis */
            border-radius: 0.375rem;
            /* 6px */
            padding: 1rem;
            margin-top: 1.5rem;
        }

        .results-display-area-title {
            /* Replaced results-card-title */
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.75rem;
        }

        .gpa-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1d4ed8;
            /* Blue 700 */
        }

        .overall-credits-text {
            font-size: 0.95rem;
            font-weight: 500;
            color: #374151;
            /* Gray 700 */
        }

        #messageBox {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1rem;
            border-radius: 0.25rem;
            /* 4px */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            font-weight: 500;
            /* Medium */
            max-width: 90%;
            text-align: center;
            font-size: 0.875rem;
            /* text-sm */
        }

        #messageBox.success {
            background-color: #16a34a;
            color: white;
        }

        #messageBox.error {
            background-color: #dc2626;
            color: white;
        }

        .copyright,
        .disclaimer {
            font-size: 0.75rem;
            /* text-xs */
            color: #6b7280;
            /* Gray 500 */
            margin-top: 1.25rem;
            text-align: center;
        }

        .disclaimer {
            padding: 0.625rem;
            background-color: #f3f4f6;
            /* Gray 100 */
            border: 1px solid #e5e7eb;
            /* Gray 200 */
            border-radius: 0.25rem;
            /* 4px */
        }

        #analysisResultDiv {
            white-space: pre-wrap;
            background-color: #f0f9ff;
            /* Sky 50, very light blue */
            border: 1px solid #e0f2fe;
            /* Sky 100 */
            border-radius: 0.375rem;
            /* 6px */
            padding: 0.875rem;
            margin-top: 1rem;
            color: #0c4a6e;
            /* Sky 800 */
            font-size: 0.875rem;
            /* text-sm */
            line-height: 1.6;
        }

        .loading-spinner {
            border: 2.5px solid rgba(0, 0, 0, 0.05);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #2563eb;
            /* Blue 600 */
            animation: spin 1s ease infinite;
            margin: 0.75rem auto 0.375rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .start-options label {
            display: block;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            /* Gray 300 */
            border-radius: 0.25rem;
            /* 4px */
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            background-color: #ffffff;
        }

        .start-options label:hover {
            border-color: #9ca3af;
            /* Gray 400 */
            background-color: #f9fafb;
            /* Gray 50 */
        }

        .start-options label h3 {
            font-size: 0.95rem;
            font-weight: 500;
            /* Medium */
            color: #111827;
            margin-bottom: 0.125rem;
        }

        .start-options label p {
            font-size: 0.8rem;
            color: #4b5563;
            /* Gray 600 */
        }

        .start-options input[type="radio"]:checked+label {
            background-color: #dbeafe;
            /* Blue 100 */
            border-color: #2563eb;
            /* Blue 600 */
        }

        .start-options input[type="radio"] {
            display: none;
        }

        /* Icon Styling */
        .icon-sm {
            width: 0.875rem;
            height: 0.875rem;
            margin-left: 0.25rem;
            margin-right: 0.25rem;
        }

        .icon-md {
            width: 1rem;
            height: 1rem;
            margin-left: 0.375rem;
            margin-right: 0.375rem;
        }

        .icon-lg {
            width: 1.125rem;
            height: 1.125rem;
            margin-left: 0.5rem;
            margin-right: 0.5rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="app-header">
            <h1>حساب الGPA</h1>
            <p>أدخل بياناتك لحساب معدلك الأكاديمي بسهولة.</p>
        </header>

        <section id="startOptionsSection" class="section">
            <h2 class="section-title">1. كيف تود البدء؟</h2>
            <div class="start-options grid grid-cols-1 md:grid-cols-2 gap-2">
                <div>
                    <input type="radio" id="startFresh" name="startOption" value="fresh" checked>
                    <label for="startFresh">
                        <h3><svg xmlns="http://www.w3.org/2000/svg" class="icon-sm inline-block" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z"
                                    clip-rule="evenodd" />
                            </svg>بداية جديدة</h3>
                        <p>إضافة فصول دراسية حالية فقط.</p>
                    </label>
                </div>
                <div>
                    <input type="radio" id="startWithPrevious" name="startOption" value="previous">
                    <label for="startWithPrevious">
                        <h3><svg xmlns="http://www.w3.org/2000/svg" class="icon-sm inline-block" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path
                                    d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm0 2h12v4H4V6zm0 8a2 2 0 00-2 2v.993A2.001 2.001 0 002.993 20H17a2 2 0 002-2v-4a2 2 0 00-2-2H4zm0 2h12v2H4v-2z" />
                            </svg>استكمال المسيرة</h3>
                        <p>إدخال معدلك وساعاتك السابقة.</p>
                    </label>
                </div>
            </div>
        </section>

        <section id="previousGPASection" class="section hidden">
            <h2 class="section-title">2. بياناتك التراكمية السابقة (إن وجدت)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label for="prevGPAInput" class="block text-sm font-medium text-gray-700 mb-1">المعدل التراكمي
                        السابق:</label>
                    <input type="number" id="prevGPAInput" step="0.001" min="0" max="4" class="input-field"
                        placeholder="مثال: 3.500">
                </div>
                <div>
                    <label for="prevCreditsInput" class="block text-sm font-medium text-gray-700 mb-1">إجمالي الساعات
                        المعتمدة السابقة:</label>
                    <input type="number" id="prevCreditsInput" step="1" min="0" class="input-field"
                        placeholder="مثال: 60">
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title" id="currentSemestersTitle">3. الفصول الدراسية الحالية</h2>
            <div id="semestersContainer">
            </div>
            <div class="mt-3">
                <button id="addSemesterBtn" class="btn btn-secondary w-full sm:w-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-md" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                            clip-rule="evenodd" />
                    </svg>
                    إضافة فصل دراسي
                </button>
            </div>
        </section>

        <div class="mt-6 mb-4 text-center">
            <button id="calculateOverallGPABtn" class="btn btn-primary btn-lg w-full md:w-auto px-8 py-3 text-base">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon-lg" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9 7h6m0 10v-3m-3 3h3m-3-10l-3 3m3-3l3 3m0 0l-3 3m3-3l3-3M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h10a2 2 0 002-2v-1a2 2 0 012-2h1.945M7.758 4.586A2.25 2.25 0 0110.001 3h4.002a2.25 2.25 0 012.243 1.586l.5 1.5H7.258l.5-1.5z" />
                </svg>
                احسب المعدل الكلي
            </button>
        </div>

        <section id="overallResultsSection" class="results-display-area hidden">
            <h2 class="results-display-area-title">النتائج النهائية:</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 items-center">
                <div class="text-center sm:text-right">
                    <p class="text-gray-600 text-sm mb-0.5">المعدل التراكمي الكلي:</p>
                    <p id="overallCumulativeGPA" class="gpa-value">0.000</p>
                </div>
                <div class="text-center sm:text-right">
                    <p class="text-gray-600 text-sm mb-0.5">إجمالي الساعات المكتسبة:</p>
                    <p id="overallTotalCredits" class="overall-credits-text text-lg">0</p>
                </div>
            </div>
            <div class="mt-4 text-center">
                <button id="getAnalysisBtn" class="btn btn-success px-5 py-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-md" viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                    تحليل أدائي و نصائح مخصصة
                </button>
            </div>
            <div id="analysisLoadingIndicator" class="hidden mt-3">
                <div class="loading-spinner"></div>
                <p class="text-center text-gray-500 text-xs">جاري تحليل أدائك... يرجى الانتظار.</p>
            </div>
            <div id="analysisResultDiv" class="hidden">
            </div>
        </section>

        <div class="disclaimer mt-6 text-xs">
            <h3 class="font-semibold mb-0.5">إخلاء مسؤولية:</h3>
            <p>هذه الحاسبة هي أداة تقديرية فقط. قد تختلف طرق حساب المعدل بين المؤسسات التعليمية. يرجى دائمًا الرجوع إلى
                جامعتك أو كليتك للحصول على حسابات المعدل الرسمية والتحقق من صحة النتائج. النصائح المقدمة هي لأغراض
                إرشادية عامة ولا تغني عن الاستشارة الأكاديمية المتخصصة.</p>
        </div>

        <div class="copyright text-xs mt-3">
            <p>&copy; <span id="currentYear"></span> تطوير بواسطة أحمد يوسف جميع الحقوق محفوظة.</p>
        </div>
    </div>

    <div id="messageBox"><span id="messageText"></span></div>

    <script>
        const semestersContainer = document.getElementById('semestersContainer');
        const addSemesterBtn = document.getElementById('addSemesterBtn');
        const calculateOverallGPABtn = document.getElementById('calculateOverallGPABtn');
        const overallResultsSection = document.getElementById('overallResultsSection');
        const overallCumulativeGPADisplay = document.getElementById('overallCumulativeGPA');
        const overallTotalCreditsDisplay = document.getElementById('overallTotalCredits');
        const currentYearSpan = document.getElementById('currentYear');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        const getAnalysisBtn = document.getElementById('getAnalysisBtn');
        const analysisLoadingIndicator = document.getElementById('analysisLoadingIndicator');
        const analysisResultDiv = document.getElementById('analysisResultDiv');

        const startOptionsRadios = document.querySelectorAll('input[name="startOption"]');
        const previousGPASection = document.getElementById('previousGPASection');
        const prevGPAInputElement = document.getElementById('prevGPAInput');
        const prevCreditsInputElement = document.getElementById('prevCreditsInput');
        const currentSemestersTitle = document.getElementById('currentSemestersTitle');


        if (currentYearSpan) {
            currentYearSpan.textContent = new Date().getFullYear();
        }

        const gradePoints = {
            'A+': 4.0, 'A': 4.0, 'A-': 3.7,
            'B+': 3.3, 'B': 3.0, 'B-': 2.7,
            'C+': 2.3, 'C': 2.0, 'C-': 1.7,
            'D+': 1.3, 'D': 1.0, 'D-': 0.7,
            'F': 0.0
        };
        const gradeOptions = ['A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D' ,'D-', 'F'];

        let semesterCounter = 0;
        let allSemestersDataForAnalysis = [];

        function showAppMessage(message, type = 'error', duration = 3500) {
            messageText.textContent = message;
            messageBox.className = '';
            messageBox.classList.add(type);
            messageBox.style.display = 'block';
            setTimeout(() => { messageBox.style.display = 'none'; }, duration);
        }

        startOptionsRadios.forEach(radio => {
            radio.addEventListener('change', function () {
                if (this.value === 'previous') {
                    previousGPASection.classList.remove('hidden');
                    currentSemestersTitle.textContent = "3. الفصول الدراسية الحالية (بالإضافة للرصيد السابق)";
                } else {
                    previousGPASection.classList.add('hidden');
                    prevGPAInputElement.value = '';
                    prevCreditsInputElement.value = '';
                    currentSemestersTitle.textContent = "2. الفصول الدراسية الحالية";
                }
                semestersContainer.innerHTML = '';
                semesterCounter = 0;
                addSemester();
                overallResultsSection.classList.add('hidden');
                getAnalysisBtn.classList.add('hidden');
                analysisResultDiv.classList.add('hidden');
                analysisResultDiv.innerHTML = '';
            });
        });


        function createCourseRow(semesterId) {
            const courseRow = document.createElement('div');
            courseRow.classList.add('course-row');

            const courseNameInput = document.createElement('input');
            courseNameInput.type = 'text';
            courseNameInput.placeholder = `اسم المادة (اختياري)`;
            courseNameInput.classList.add('input-field', 'course-name');

            const creditsInput = document.createElement('input');
            creditsInput.type = 'number';
            creditsInput.step = '1'; // Changed step to 1
            creditsInput.min = '0';
            creditsInput.placeholder = 'الساعات';
            creditsInput.classList.add('input-field', 'course-credits');
            creditsInput.required = true;

            const gradeSelect = document.createElement('select');
            gradeSelect.classList.add('select-field', 'course-grade');
            gradeSelect.required = true;
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "التقدير";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            gradeSelect.appendChild(defaultOption);
            gradeOptions.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                gradeSelect.appendChild(option);
            });

            const removeCourseBtn = document.createElement('button');
            removeCourseBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.498a.75.75 0 00-.5.863l.841 4.208A2.75 2.75 0 006.75 12h6.5a2.75 2.75 0 002.744-2.23l.841-4.208a.75.75 0 00-.5-.863c-.784-.278-1.57-.421-2.365-.498V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.538-.054 2.23-.159l.67 3.352A1.25 1.25 0 0111.75 8h-3.5a1.25 1.25 0 01-1.15-.793L6.439 3.841A26.202 26.202 0 0110 4zM4.43 8.25A1.25 1.25 0 003.25 9.5v5A1.25 1.25 0 004.5 15.75h11A1.25 1.25 0 0016.75 14.5v-5A1.25 1.25 0 0015.57 8.25A24.46 24.46 0 0110 8.5a24.46 24.46 0 01-5.57-.25z" clip-rule="evenodd" /></svg>`;
            removeCourseBtn.classList.add('btn', 'btn-danger', 'btn-icon');
            removeCourseBtn.type = 'button';
            removeCourseBtn.title = "حذف المادة";
            removeCourseBtn.onclick = () => courseRow.remove(); // Corrected: Directly remove the courseRow

            courseRow.append(courseNameInput, creditsInput, gradeSelect, removeCourseBtn);
            return courseRow;
        }

        function addSemester() {
            semesterCounter++;
            const semesterBlock = document.createElement('div');
            semesterBlock.classList.add('semester-block');
            semesterBlock.id = `semester-${semesterCounter}`;

            const semesterHeader = document.createElement('div');
            semesterHeader.classList.add('semester-header');

            const semesterTitleInput = document.createElement('input');
            semesterTitleInput.type = 'text';
            semesterTitleInput.value = `الفصل الدراسي ${semesterCounter}`;
            semesterTitleInput.classList.add('semester-title-input');
            semesterTitleInput.placeholder = "اسم الفصل (مثال: ربيع 2024)";

            const removeSemesterBtn = document.createElement('button');
            removeSemesterBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon-sm"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg> إزالة الفصل`;
            removeSemesterBtn.classList.add('btn', 'btn-danger', 'text-xs', 'py-1', 'px-1.5');
            removeSemesterBtn.onclick = () => semesterBlock.remove(); // Corrected: Directly remove the semesterBlock

            semesterHeader.append(semesterTitleInput, removeSemesterBtn);

            const coursesDiv = document.createElement('div');
            coursesDiv.classList.add('courses-list', 'mt-2');

            const addCourseBtnSemester = document.createElement('button');
            addCourseBtnSemester.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="icon-sm"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg> إضافة مادة`;
            addCourseBtnSemester.classList.add('btn', 'btn-secondary', 'text-xs', 'py-1', 'px-1.5');

            addCourseBtnSemester.onclick = () => coursesDiv.appendChild(createCourseRow(`semester-${semesterCounter}`));

            const semesterResultDiv = document.createElement('div');
            semesterResultDiv.classList.add('mt-2', 'p-1.5', 'bg-slate-100', 'rounded-md');
            semesterResultDiv.innerHTML = `
                <p class="text-xs text-slate-600">معدل الفصل: <span class="font-semibold text-sky-700 semester-gpa-display">N/A</span></p>
                <p class="text-xs text-slate-600">ساعات الفصل: <span class="font-semibold text-sky-700 semester-credits-display">N/A</span></p>
            `;

            semesterBlock.append(semesterHeader, coursesDiv, addCourseBtnSemester, semesterResultDiv);
            semestersContainer.appendChild(semesterBlock);

            coursesDiv.appendChild(createCourseRow(`semester-${semesterCounter}`));
        }

        function calculateOverallGPA() {
            allSemestersDataForAnalysis = [];
            let overallTotalPoints = 0;
            let overallTotalCredits = 0;
            let allSemestersValid = true;

            analysisResultDiv.classList.add('hidden');
            analysisResultDiv.innerHTML = '';
            getAnalysisBtn.classList.add('hidden');


            const startOptionSelected = document.querySelector('input[name="startOption"]:checked').value;
            if (startOptionSelected === 'previous') {
                const prevGPA = parseFloat(prevGPAInputElement.value);
                const prevCredits = parseFloat(prevCreditsInputElement.value);

                prevGPAInputElement.classList.remove('border-red-500');
                prevCreditsInputElement.classList.remove('border-red-500');

                if (!isNaN(prevGPA) && !isNaN(prevCredits) && prevGPA >= 0 && prevCredits >= 0) {
                    if (prevCredits == 0 && prevGPA > 0) {
                        showAppMessage('لا يمكن أن يكون المعدل التراكمي السابق أكبر من صفر إذا كانت الساعات السابقة صفر.', 'error');
                        prevGPAInputElement.classList.add('border-red-500');
                        prevCreditsInputElement.classList.add('border-red-500');
                        overallResultsSection.classList.add('hidden');
                        return;
                    }
                    overallTotalPoints += prevGPA * prevCredits;
                    overallTotalCredits += prevCredits;
                    allSemestersDataForAnalysis.push({
                        semesterName: "البيانات التراكمية السابقة",
                        semesterGPA: prevGPA.toFixed(3),
                        semesterCredits: prevCredits.toFixed(1),
                        courses: [{ name: "ملخص الساعات السابقة", credits: prevCredits, grade: `GPA: ${prevGPA.toFixed(3)}` }]
                    });
                } else if ((prevGPAInputElement.value && (isNaN(prevGPA) || prevGPA < 0)) || (prevCreditsInputElement.value && (isNaN(prevCredits) || prevCredits < 0)) || (prevGPAInputElement.value && !prevCreditsInputElement.value) || (!prevGPAInputElement.value && prevCreditsInputElement.value)) {
                    showAppMessage('الرجاء إدخال قيم صحيحة (أكبر من أو تساوي صفر) للمعدل التراكمي السابق والساعات السابقة معًا، أو تركهما فارغين.', 'error');
                    if (isNaN(prevGPA) || prevGPA < 0 || (prevGPAInputElement.value && !prevCreditsInputElement.value)) prevGPAInputElement.classList.add('border-red-500');
                    if (isNaN(prevCredits) || prevCredits < 0 || (!prevGPAInputElement.value && prevCreditsInputElement.value)) prevCreditsInputElement.classList.add('border-red-500');
                    overallResultsSection.classList.add('hidden');
                    return;
                }
            }


            const semesterBlocks = semestersContainer.querySelectorAll('.semester-block');

            if (semesterBlocks.length === 0 && startOptionSelected === 'fresh') {
                showAppMessage('الرجاء إضافة فصل دراسي حالي واحد على الأقل.', 'error');
                overallResultsSection.classList.add('hidden');
                return;
            }

            semesterBlocks.forEach(block => {
                const semesterTitleInput = block.querySelector('.semester-title-input');
                let semesterTotalPoints = 0;
                let semesterTotalCredits = 0;
                let semesterValid = true;
                const courseRows = block.querySelectorAll('.course-row');
                const semesterGPADisp = block.querySelector('.semester-gpa-display');
                const semesterCreditsDisp = block.querySelector('.semester-credits-display');

                const semesterCoursesData = [];

                if (courseRows.length === 0) {
                    semesterGPADisp.textContent = "0.000";
                    semesterCreditsDisp.textContent = "0";
                } else {
                    courseRows.forEach(row => {
                        const courseNameInput = row.querySelector('.course-name');
                        const creditsInput = row.querySelector('.course-credits');
                        const gradeSelect = row.querySelector('.course-grade');
                        const credits = parseFloat(creditsInput.value);
                        const grade = gradeSelect.value;

                        creditsInput.classList.remove('border-red-500');
                        gradeSelect.classList.remove('border-red-500');

                        if (isNaN(credits) || credits <= 0) {
                            creditsInput.classList.add('border-red-500');
                            semesterValid = false;
                        }
                        if (!grade || !gradePoints.hasOwnProperty(grade)) {
                            gradeSelect.classList.add('border-red-500');
                            semesterValid = false;
                        }

                        if (semesterValid) {
                            semesterTotalPoints += gradePoints[grade] * credits;
                            semesterTotalCredits += credits;
                            semesterCoursesData.push({
                                name: courseNameInput.value || "مادة غير مسماة",
                                credits: credits,
                                grade: grade
                            });
                        }
                    });
                }


                if (!semesterValid) {
                    allSemestersValid = false;
                    semesterGPADisp.textContent = "خطأ";
                    semesterCreditsDisp.textContent = "خطأ";
                } else if (courseRows.length > 0) {
                    const currentSemesterGPA = semesterTotalCredits > 0 ? (semesterTotalPoints / semesterTotalCredits) : 0;
                    semesterGPADisp.textContent = currentSemesterGPA.toFixed(3);
                    semesterCreditsDisp.textContent = semesterTotalCredits.toFixed(1);
                    overallTotalPoints += semesterTotalPoints;
                    overallTotalCredits += semesterTotalCredits;
                    allSemestersDataForAnalysis.push({
                        semesterName: semesterTitleInput.value || `الفصل (بدون اسم)`,
                        semesterGPA: currentSemesterGPA.toFixed(3),
                        semesterCredits: semesterTotalCredits.toFixed(1),
                        courses: semesterCoursesData
                    });
                } else {
                    semesterGPADisp.textContent = "0.000";
                    semesterCreditsDisp.textContent = "0";
                }
            });

            if (!allSemestersValid) {
                showAppMessage('الرجاء تصحيح الأخطاء في بيانات المواد (الساعات والتقديرات).', 'error');
                overallResultsSection.classList.add('hidden');
                return;
            }

            if (overallTotalCredits === 0) {
                const hasPreviousDataAttempt = startOptionSelected === 'previous' && (prevGPAInputElement.value || prevCreditsInputElement.value);
                const hasCurrentSemesterBlocks = semesterBlocks.length > 0 && Array.from(semesterBlocks).some(sb => sb.querySelectorAll('.course-row').length > 0);

                if (hasPreviousDataAttempt || hasCurrentSemesterBlocks) {
                    overallCumulativeGPADisplay.textContent = "0.000";
                    overallTotalCreditsDisplay.textContent = "0";
                    overallResultsSection.classList.remove('hidden');
                    getAnalysisBtn.classList.remove('hidden');
                    showAppMessage('تم حساب المعدل. لا توجد ساعات معتمدة مكتسبة أو مدخلة بشكل صحيح.', 'success');
                } else {
                    showAppMessage('لا توجد بيانات لحساب المعدل. يرجى إضافة فصول دراسية أو بيانات سابقة.', 'error');
                    overallResultsSection.classList.add('hidden');
                }
                return;
            }


            const finalCumulativeGPA = overallTotalCredits > 0 ? (overallTotalPoints / overallTotalCredits) : 0;
            overallCumulativeGPADisplay.textContent = finalCumulativeGPA.toFixed(3);
            overallTotalCreditsDisplay.textContent = overallTotalCredits.toFixed(1);

            overallResultsSection.classList.remove('hidden');
            getAnalysisBtn.classList.remove('hidden');
            overallResultsSection.scrollIntoView({ behavior: 'smooth' });
            showAppMessage('تم حساب المعدل التراكمي الكلي بنجاح!', 'success');
        }

        async function fetchAnalysis() {
            const isResultSectionHidden = overallResultsSection.classList.contains('hidden');

            if (isResultSectionHidden) {
                showAppMessage('يرجى حساب المعدل التراكمي الكلي أولاً.', 'error');
                return;
            }


            analysisLoadingIndicator.classList.remove('hidden');
            analysisResultDiv.classList.add('hidden');
            analysisResultDiv.innerHTML = '';
            getAnalysisBtn.classList.add('hidden');

            let promptDetails = "تفاصيل الفصول الدراسية:\n";
            if (allSemestersDataForAnalysis.length > 0) {
                allSemestersDataForAnalysis.forEach(sem => {
                    promptDetails += `الفصل: ${sem.semesterName}\n`;
                    promptDetails += `  المعدل الفصلي: ${sem.semesterGPA}\n`;
                    promptDetails += `  الساعات المعتمدة للفصل: ${sem.semesterCredits}\n`;
                    if (sem.courses && sem.courses.length > 0 && sem.semesterName !== "البيانات التراكمية السابقة") {
                        promptDetails += `  المواد:\n`;
                        sem.courses.forEach(course => {
                            promptDetails += `    - المادة: ${course.name}, التقدير: ${course.grade}, الساعات: ${course.credits}\n`;
                        });
                    } else if (sem.semesterName === "البيانات التراكمية السابقة") {
                        promptDetails += `    - (ملخص البيانات السابقة)\n`;
                    }
                    else {
                        promptDetails += `    - لا توجد مواد مسجلة لهذا الفصل.\n`;
                    }
                    promptDetails += "\n";
                });
            } else {
                promptDetails += "لم يتم إدخال بيانات تفصيلية للفصول الدراسية ولكن المعدل الكلي هو ما تم حسابه.\n";
            }


            const prompt = `أنا طالب وهذا هو ملخص أدائي الأكاديمي:
المعدل التراكمي الكلي: ${overallCumulativeGPADisplay.textContent}
إجمالي الساعات المكتسبة: ${overallTotalCreditsDisplay.textContent}

${promptDetails}
يرجى تقديم تحليل شامل لأدائي الأكاديمي. يجب أن يتضمن التحليل:
1. نظرة عامة على المستوى العام للمعدل التراكمي الكلي والفصلي (إذا توفرت فصول متعددة).
2. تحديد الاتجاهات في الأداء (هل هناك تحسن، تراجع، أو استقرار عبر الفصول؟).
3. إبراز نقاط القوة والمواد أو أنواع المواد التي يظهر فيها أداء جيد.
4. تحديد مجالات التحسين والمواد التي تحتاج إلى تركيز أكبر، مع اقتراح أسباب محتملة لذلك الأداء.
5. تقديم 3-5 نصائح عملية ومخصصة بناءً على هذا التحليل لمساعدتي على تحسين أدائي في المستقبل. يجب أن تكون النصائح قابلة للتنفيذ وموجهة للطالب (مثال: استراتيجيات دراسة محددة، نصائح لإدارة الوقت، متى يجب طلب المساعدة).
قدم الرد باللغة العربية وبتنسيق واضح وسهل القراءة، استخدم نقاطًا أو قوائم مرقمة عند تقديم النصائح.`;

            const apiKey = "AIzaSyDshaPXHSapYMrO6yv7I-n9upiUntpWFbU";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    throw new Error(`فشل في الاتصال بخدمة التحليل. الحالة: ${response.status}. ${errorData?.error?.message || ''}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const analysisText = result.candidates[0].content.parts[0].text;
                    analysisResultDiv.textContent = analysisText;
                    analysisResultDiv.classList.remove('hidden');
                } else {
                    throw new Error('لم يتم استلام تحليل من الخدمة. قد يكون الرد فارغًا.');
                }

            } catch (error) {
                console.error('Error fetching analysis:', error);
                showAppMessage(`حدث خطأ أثناء محاولة الحصول على التحليل: ${error.message}`, 'error');
                analysisResultDiv.textContent = 'عذرًا، لم نتمكن من الحصول على التحليل في الوقت الحالي. يرجى المحاولة مرة أخرى لاحقًا.';
                analysisResultDiv.classList.remove('hidden');
            } finally {
                analysisLoadingIndicator.classList.add('hidden');
            }
        }


        addSemesterBtn.addEventListener('click', addSemester);
        calculateOverallGPABtn.addEventListener('click', calculateOverallGPA);
        getAnalysisBtn.addEventListener('click', fetchAnalysis);

        document.addEventListener('DOMContentLoaded', () => {
            const freshStartRadio = document.getElementById('startFresh');
            if (freshStartRadio.checked) {
                currentSemestersTitle.textContent = "2. الفصول الدراسية الحالية";
            }
            addSemester();
            getAnalysisBtn.classList.add('hidden');
        });
    </script>
</body>

</html>
